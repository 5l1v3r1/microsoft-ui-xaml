parameters:
  dependsOn: ''

jobs:
- job: BuildPGD
  dependsOn: ${{ parameters.dependsOn }}
  pool:
    vmImage: 'windows-2019'
  variables:
    artifactsPath: $(Build.SourcesDirectory)\Artifacts
    pgoArtifactsPath: $(artifactsPath)\drop\PGO\Release
    nugetPath: $(Build.SourcesDirectory)\tools\MUXPGODatabase\NuSpecs

  steps:
  # The environment variable VCToolsInstallDir isn't defined on lab machines, so we need to retrieve it ourselves.
  - script: |
      "%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -Latest -requires Microsoft.Component.MSBuild -property InstallationPath > %TEMP%\vsinstalldir.txt
      set /p _VSINSTALLDIR15=<%TEMP%\vsinstalldir.txt
      del %TEMP%\vsinstalldir.txt
      call "%_VSINSTALLDIR15%\Common7\Tools\VsDevCmd.bat"
      echo VCToolsInstallDir = %VCToolsInstallDir%
      echo ##vso[task.setvariable variable=VCToolsInstallDir]%VCToolsInstallDir%
    displayName: 'Retrieve VC tools directory'

  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: drop
      downloadPath: $(artifactsPath)

  - script: |
      pushd x86
      "%VCToolsInstallDir%\bin\hostx64\x64\pgomgr.exe" /merge *.pgc microsoft.ui.xaml.pgd
      popd

      pushd x64
      "%VCToolsInstallDir%\bin\hostx64\x64\pgomgr.exe" /merge *.pgc microsoft.ui.xaml.pgd
      popd
    displayName: 'Merge pgc files into pgd'
    workingDirectory: $(pgoArtifactsPath)

  - task: CopyFiles@2
    displayName: 'Copy merged pgd to artifact staging'
    inputs:
      sourceFolder: $(pgoArtifactsPath)
      contents: '**\Microsoft.UI.Xaml.pgd'
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: CopyFiles@2
    displayName: 'Copy pgd files to NuGet build directory'
    inputs:
      sourceFolder: $(pgoArtifactsPath)
      contents: '**\Microsoft.UI.Xaml.pgd'
      targetFolder: $(nugetPath)\tools

  - task: CmdLine@1
    displayName: 'Build NuGet package'
    inputs:
      filename: '$(Build.SourcesDirectory)\tools\NugetWrapper.cmd'
      arguments: pack "$(nugetPath)\MUXPGODatabase.nuspec" -BasePath "$(nugetPath)" -OutputDirectory "$(Build.ArtifactStagingDirectory)" -properties PROGRAMFILES="%ProgramFiles(x86)%"

  - task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
    displayName: 'NuGet push'
    inputs:
      command: push
      publishVstsFeed: https://microsoft.pkgs.visualstudio.com/DefaultCollection/_packaging/DEPControls/nuget/v3/index.json
      packagesToPush: $(Build.ArtifactStagingDirectory)/*.nupkg

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)
      artifactName: PGO